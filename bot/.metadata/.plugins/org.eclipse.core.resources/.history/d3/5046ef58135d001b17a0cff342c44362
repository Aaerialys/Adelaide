package bot;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.PrintStream;
import java.util.Timer;
import java.util.TimerTask;

import org.javacord.api.DiscordApi;
import org.javacord.api.DiscordApiBuilder;
import org.javacord.api.entity.intent.Intent;
import org.json.simple.parser.ParseException;

public class Main {
    private static BotListener bot;
    private final static int SAVEFREQUENCY=120000;		//frequency to save information, in milliseconds
    private static class SaveState extends TimerTask {	//saves information on the bot
        public void run() {
            bot.save();
        }
    }
    public static void main(String[] args) {
    	PrintStream out;
		try { 											//sets output stream to a log file for debugging and other information
			out = new PrintStream(new FileOutputStream(new File("log.txt")));
	    	System.setErr(out);
	    	//System.setOut(out);
		} catch (FileNotFoundException e) {
			System.err.println("Log file not found");
			e.printStackTrace();
		}
        DiscordApi api = new DiscordApiBuilder().setToken("Nzk5NDc3OTQ1MjE1MDkwNjg4.YAEJ2w.Rf1gAsGvWNbagEmZmLBswe6Bg5I") //connects bot to discord api
            .setAllIntentsExcept(Intent.GUILD_PRESENCES).login().join();
        bot = new BotListener(api);						//creates new message listener and adds it to the current bot
        api.addListener(bot); 
        DmojCfApi.updateCache();		 				//updates the cache of dmoj and codeforces problems
        api.getOwner().join().sendMessage("Starting the bot"); //sends startup message
        System.out.println("Bot started");
        Timer timer = new Timer();						//sets a timer to save bot data every 2 minutes
        timer.schedule(new SaveState(), 0, SAVEFREQUENCY);
        for(int i=0;i<70;i++)
			try {
				DmojCfApi.query("https://dmoj.ca/api/v2/contest/bts19");
			} catch (IOException | ParseException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		System.out.println("done");
    }
}